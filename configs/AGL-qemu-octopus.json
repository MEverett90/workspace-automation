{
    "id": "AGL-qemu",
    "load": false,
    "supported_archs": ["x86_64"],
    "supported_host_types": ["ubuntu"],
    "flutter_runtime": "debug",
    "type": "qemu",
    "env": {
        "RELEASE_NAME": "octopus",
        "RELEASE_VERSION": "latest",
        "FLUTTER_DEBUG_PORT": "1234",
        "FLUTTER_OBSERVATORY_HOST": "0.0.0.0",
        "CONTAINER_SSH_PORT": "2222"
    },
    "runtime": {
        "config": {
            "view": {
                "window_type": "BG",
                "width": 1920,
                "height": 1080,
                "fullscreen": true
            }
        },
        "artifacts": {
            "url": "https://download.automotivelinux.org/AGL/release/${RELEASE_NAME}/${RELEASE_VERSION}",
            "artifacts": {
                "x86_64": [
                    {
                        "endpoint": "/qemux86-64/deploy/images/qemux86-64/agl-demo-platform-crosssdk-qemux86-64.ext4.xz"
                    },
                    {
                        "endpoint": "/qemux86-64/deploy/images/qemux86-64/zImage-qemuarm.bin"
                    }
                ],
                "arm64": [
                    {
                        "endpoint": "/qemuarm64/deploy/images/qemuarm64/agl-demo-platform-crosssdk-qemuarm64.ext4.xz"
                    },
                    {
                        "endpoint": "/qemuarm64/deploy/images/qemuarm64/Image-qemuarm64.bin"
                    }
                ]
            }
        },
        "qemu": {
            "cmd": "qemu-system-${FORMAL_MACHINE_ARCH}",
            "x86_64": {
                "args": "-m 2048 ${QEMU_EXTRA} -hda ${QEMU_IMAGE} -cpu kvm64 -cpu qemu64,+ssse3,+sse4.1,+sse4.2,+popcnt -vga virtio -device virtio-rng-pci -serial mon:stdio -serial null -soundhw hda -device virtio-net-pci,netdev=net0,mac=${RANDOM_MAC} -netdev user,id=net0,hostfwd=tcp::${CONTAINER_SSH_PORT}-:22,hostfwd=tcp::${FLUTTER_DEBUG_PORT}-:${FLUTTER_DEBUG_PORT}",
                "qemu_image": ".agl/agl-image-flutter-runtime${FLUTTER_RUNTIME}-qemux86-64.wic.vmdk"
            },
            "arm64": {
                "kernel": ".agl/Image-qemuarm64.bin",
                "args": "-accel hvf -cpu host -M virt ${QEMU_EXTRA} -m 4096 -device virtio-gpu-pci -nographic -display cocoa,show-cursor=on -object rng-random,filename=/dev/urandom,id=rng0 -device virtio-rng-pci,rng=rng0 -device qemu-xhci -device usb-tablet -device usb-mouse -device usb-kbd -device virtio-net-pci,netdev=vnet -netdev user,id=vnet,hostfwd=tcp::${CONTAINER_SSH_PORT}-:22,hostfwd=tcp::${FLUTTER_DEBUG_PORT}-:${FLUTTER_DEBUG_PORT} -kernel ${KERNEL} -drive file=${QEMU_IMAGE},format=raw,if=virtio -append root=/dev/vda",
                "qemu_image": ".agl/agl-image-flutter-runtime${FLUTTER_RUNTIME}-qemuarm64.ext4"
            },
            "extra": {
                "darwin": "-smp cpus=8,sockets=1,cores=8,threads=1",
                "ubuntu": "-bios OVMF.fd",
                "fedora": "-bios /usr/share/edk2/ovmf/OVMF_CODE.fd"
            }
        }
    },
    "overwrite-existing": true,
    "custom-device": {
        "id": "AGL-qemu",
        "label": "AGL ${MACHINE_ARCH} QEMU Image",
        "sdkNameAndVersion": "agl-image-flutter-runtime${FLUTTER_RUNTIME}-qemu${MACHINE_ARCH_HYPHEN}",
        "platform": "linux-x64",
        "enabled": true,
        "ping": "(echo >/dev/tcp/localhost/${CONTAINER_SSH_PORT}) &>/dev/null && echo \"open ${CONTAINER_SSH_PORT}\" || echo \"close ${CONTAINER_SSH_PORT}\"",
        "pingSuccessRegex": "open ${CONTAINER_SSH_PORT}",
        "postBuild": "mkdir -p ${localPath}/../../.flutter-auto/data/flutter_assets && cp -r ${localPath}/* ${localPath}/../../.flutter-auto/data/flutter_assets && cp -r ${FLUTTER_WORKSPACE}/.agl/default_config.json ${localPath}/../../.flutter-auto/ && ssh -p ${CONTAINER_SSH_PORT} -t -oBatchMode=yes root@localhost passwd -d agl-driver",
        "uninstall": "ssh -p ${CONTAINER_SSH_PORT} -t -t -oBatchMode=yes agl-driver@localhost rm -rf \"/tmp/${appName}\"",
        "install": "ssh -p ${CONTAINER_SSH_PORT} -t -t -oBatchMode=yes agl-driver@localhost mkdir -p \"/tmp/${appName}/data/flutter_assets\" && scp -r -P ${CONTAINER_SSH_PORT} ${localPath}/../../.flutter-auto/* agl-driver@localhost:/tmp/${appName}",
        "runDebug": "ssh -t -t -p ${CONTAINER_SSH_PORT} -oBatchMode=yes agl-driver@localhost flutter-auto --j=/tmp/${appName}/default_config.json --b=/tmp/${appName} --observatory-host=${FLUTTER_OBSERVATORY_HOST} --observatory-port=${FLUTTER_DEBUG_PORT}",
        "forwardPort": null,
        "forwardPortSuccessRegex": null,
        "screenshot": null
    }
}
